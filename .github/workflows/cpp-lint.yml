name: C++ Linting

on:
  push:
    branches: [main, sna_project]
  pull_request:
    branches: [main, sna_project]

jobs:
  lint: 
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # Setup Python (required for Conan)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # Cache Conan dependencies (stores packages in ~/.conan2)
    - name: Cache Conan packages
      id: cache-conan
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: ${{ runner.os }}-conan-${{ hashFiles('conanfile.py', 'conanfile.txt') }}

    # Install Conan (if not cached)
    - name: Install Conan
      run: pip install conan

    # Run Conan commands (will use cached packages if available)
    - name: Build and install dependencies
      run: |
        conan create . --build=missing
        cd ..
        conan install . -of build --build=missing

    - name: Set up compile_commands.json
      run: |
        git clone --branch v0.3.2 --single-branch https://github.com/Makcal/TgBotStater.git
        cd TgBotStater
        conan profile detect
        sed -i 's/compiler.cppstd=.*/compiler.cppstd=23/' ~/.conan2/profiles/default

    - name: Generate compile_commands.json
    - run: cmake -B build --fresh --preset=conan-release

    - name: Move compilation database to root
      run: mv build/compile_commands.json .

    - name: Run clang-tidy
      run: |
        # Find all C++ files and run clang-tidy on them
        find src -type f \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' \) \
          -exec clang-tidy {} --quiet \
          --warnings-as-errors='*' \
          --config-file=".clang-tidy" \;
          
