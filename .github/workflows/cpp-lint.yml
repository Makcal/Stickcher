name: C++ Linting

on:
  push:
    branches: [main, sna_project]
  pull_request:
    branches: [main, sna_project]

jobs:
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy
        sudo apt-get install pip
        pip install conan

    - name: Set up compile_commands.json
      run: |
        git clone --branch v0.3.2 --single-branch https://github.com/Makcal/TgBotStater.git
        cd TgBotStater
        conan profile detect
        sed -i 's/compiler.cppstd=.*/compiler.cppstd=23/' ~/.conan2/profiles/default
        conan create . --build=missing
        cd ..
        conan install . -of build --build=missing
        cmake -B build --fresh --preset=conan-release

    - name: Move compilation database to root
      run: mv build/compile_commands.json .

    - name: Run clang-tidy
      run: |
        # Find all C++ files and run clang-tidy on them
        find src -type f \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' \) \
          -exec clang-tidy {} --quiet \
          --warnings-as-errors='*' \
          --config-file=".clang-tidy" \;
